<html>
<head>
<title>audio test</title>
<style type="text/css">
#debu{
	diplay:block;
}
#debug p{
	font-size:12px;
	float:left;
	margin:0px;
	padding:0px;
	border:solid #0000FF 1px;
}
#wave{
	clear:both;
}
</style>
<script  type="text/javascript">
	/**
 * audio controller for chrome
 */

function	AudioController () {

	this._context	= new webkitAudioContext;
	this._bufferMap	= {};
}

AudioController.prototype.load	= function (src, callback, alias) {

	var request				= new XMLHttpRequest(),
		controller			= this;
	request.open('GET', src, true);
	request.responseType	= 'arraybuffer';
	request.onload			= function(event) {

		controller._context.decodeAudioData(request.response, function(buffer) {

			var	name					= alias	? alias	: src;
			controller._bufferMap[name]	= buffer;
			callback(event);
		});
	}
	request.send();
}

AudioController.prototype.getBuffer	= function (name) {

	return	this._bufferMap[name]	? this._bufferMap[name]	: false;

}

AudioController.prototype.getContext = function () {

	return	this._context;
} 

</script>
</head>
<body>
<div id="debug"></div>
<canvas id="wave" width="1024" height="100"></canvas>
<canvas id="freq" width="1024" height="100"></canvas>
<script type="text/javascript">

function debug (audio) {

	var	str	= '';

	for (var attr in audio) {

		str	+= ('<p>' + attr + ' : ' + audio[attr] + '</p>');
	}

	document.getElementById('debug').innerHTML	= str;
}

function displayFreq (freqByteData) {

	var	canvasContext	= document.getElementById('freq').getContext('2d');
	canvasContext.fillStyle	= '#0000FF';
	canvasContext.clearRect(0,0,1024,100);

	for (var offset = 0; offset < freqByteData.length; offset ++) {

		var	height	= (0 - (freqByteData[offset] / 255 * 100));
		canvasContext.fillRect(offset, 100, 1, height);
	}
}

function displayWave (waveByteData) {

	var	canvasContext	= document.getElementById('wave').getContext('2d');
	canvasContext.fillStyle	= '#FF0000';
	canvasContext.clearRect(0,0,1024,100);

	for (var offset = 0; offset < waveByteData.length; offset ++) {

		var	height	= (0 - (waveByteData[offset] / 255 * 100));
		canvasContext.fillRect(offset, 100, 1, height);
	}
}

var	audioController	= new AudioController;
var	sourcePath		= '../audio/test.mp3';
var	alias			= '7 days'


audioController.load(sourcePath, function () {

	var	analyser		= audioController.getContext().createAnalyser();
	var	source			= audioController.getContext().createBufferSource();
	source.buffer		= audioController.getBuffer(alias);
	source.connect(analyser);
	analyser.smoothingTimeConstant	= 0.85;
	analyser.connect(audioController.getContext().destination);

	var	timeHandler		= window.setInterval(function () {

		var	freqByteData	= new Uint8Array(analyser.frequencyBinCount);
		var	waveByteData	= new Uint8Array(analyser.frequencyBinCount);
		analyser.getByteFrequencyData(freqByteData);
		displayFreq(freqByteData);
		analyser.getByteTimeDomainData(waveByteData);
		displayWave(waveByteData);
	}, 10);

	source.start(0);
	source.ended	= function () {
	
		document.getElementById('wave').getContext('2d').clearRect(0,0,1024,100);
		document.getElementById('freq').getContext('2d').clearRect(0,0,1024,100);
		window.clearInterval(timeHandler);
	}
}, alias);
</script>
</body>
</html>